if(window.console==undefined){console={info:Ext.emptyFn,log:Ext.emptyFn,dir:Ext.emptyFn,dirxml:Ext.emptyFn,warn:Ext.emptyFn,error:Ext.emptyFn}}Ext.namespace("Xmpp4Js");var Jid_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];Xmpp4Js.Jid=function(a){this._node="";this._domain="";this._resource="";if(a!==undefined&&a!=null){if(a instanceof Xmpp4Js.Jid){this.setNode(a.getNode());this.setDomain(a.getDomain());this.setResource(a.getResource())}else{if(a.indexOf("@")!=-1){this.setNode(a.substring(0,a.indexOf("@")));a=a.substring(a.indexOf("@")+1)}if(a.indexOf("/")!=-1){this.setResource(a.substring(a.indexOf("/")+1));a=a.substring(0,a.indexOf("/"))}this.setDomain(a)}}};Xmpp4Js.Jid.prototype.getNode=function(){return this._node};Xmpp4Js.Jid.prototype.getDomain=function(){return this._domain};Xmpp4Js.Jid.prototype.getResource=function(){return this._resource};Xmpp4Js.Jid.prototype.setNode=function(a){Xmpp4Js.Jid._checkNodeName(a);this._node=a||"";return this};Xmpp4Js.Jid.prototype.setDomain=function(a){if(!a||a==""){throw new Xmpp4Js.JidInvalidException("domain name missing")}Xmpp4Js.Jid._checkNodeName(a);this._domain=a;return this};Xmpp4Js.Jid.prototype.setResource=function(a){this._resource=a||"";return this};Xmpp4Js.Jid.prototype.toString=function(){var a="";if(this.getNode()&&this.getNode()!=""){a=this.getNode()+"@"}a+=this.getDomain();if(this.getResource()&&this.getResource()!=""){a+="/"+this.getResource()}return a};Xmpp4Js.Jid.prototype.equals=function(b,a){if(!(b instanceof Xmpp4Js.Jid)){b=new Xmpp4Js.Jid(b)}var c=false;if(a){c=b.withoutResource().toString().toLowerCase()==this.withoutResource().toString().toLowerCase()}else{c=b.toString().toLowerCase()==this.toString().toLowerCase()}return c};Xmpp4Js.Jid.prototype.removeResource=function(){return this.setResource()};Xmpp4Js.Jid.prototype.withoutResource=function(){var a=new Xmpp4Js.Jid(this);return a.removeResource()};Xmpp4Js.Jid._checkNodeName=function(a){if(!a||a==""){return}for(var b=0;b<Jid_FORBIDDEN.length;b++){if(a.indexOf(Jid_FORBIDDEN[b])!=-1){throw new JidInvalidException("forbidden char in nodename: "+Jid_FORBIDDEN[b])}}};Xmpp4Js.JidInvalidException=function(a){this.message=a;this.name="JidInvalidException"};var DomBuilder=function(){};DomBuilder.node=function(n,d,m,j,l){if(!d){d={}}if(!m){m=[]}if(!l){l=Xmpp4Js.Packet.getDocument()}if(j){if(!(j instanceof DOMElement)){j=l.createTextNode(j)}m.push(j)}var a;if(d.xmlns!==undefined){a=l.createElementNS(d.xmlns,n)}else{if(n.indexOf(":")>-1){var g=n.substring(0,n.indexOf(":"));var c=d["xmlns:"+g];if(c){a=l.createElementNS(c,n)}else{a=l.createElement(n)}}else{a=l.createElement(n)}}for(var b in d){try{a.setAttribute(b,d[b])}catch(h){alert("Could not set attribute: "+b+"="+d[b]+". current="+a.getAttribute(b).toString())}}for(var f=0;f<m.length;f++){a.appendChild(m[f])}return a};Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet._document=createDocument();Xmpp4Js.Packet.getDocument=function(){return Xmpp4Js.Packet._document};Xmpp4Js.Packet.Base=function(a){this.extensions=[];this.elem=a};Xmpp4Js.Packet.Base.prototype={setId:function(a){this.elem.setAttribute("id",a)},getId:function(){var a=this.elem.getAttribute("id").toString();if(!a){a="id"+Math.random(0,100);this.setId(a)}return a},setTo:function(a){this.elem.setAttribute("to",a)},getTo:function(){return this.elem.getAttribute("to").toString()},setFrom:function(a){this.elem.setAttribute("from",a)},getFrom:function(){return this.elem.getAttribute("from").toString()},setToJid:function(a){this.elem.setAttribute("to",a.toString())},getToJid:function(){return new Xmpp4Js.Jid(this.elem.getAttribute("to").toString())},setFromJid:function(a){this.elem.setAttribute("from",a.toString())},getFromJid:function(){return new Xmpp4Js.Jid(this.elem.getAttribute("from").toString())},setType:function(a){this.elem.setAttribute("type",a)},getType:function(){return this.elem.getAttribute("type").toString()},setNode:function(a){this.elem=a},getNode:function(){return this.elem},getDoc:function(){return this.elem.ownerDocument},toString:function(){var a="Packet [node (JSON)=, type="+this.getType()+", from="+this.getFrom()+", to="+this.getTo()+", toJid=]";return a},setChildElementContent:function(c,b){var a=this.getChildElementNode(c);if(!a){a=DomBuilder.node(c);a=this.elem.appendChild(a)}if(b instanceof DOMElement){var d=this.elem.ownerDocument.importNode(b,true);a.appendChild(d)}else{a.setTextContent(b)}},getChildElementNode:function(a){return this.elem.getElementsByTagName(a).item(0)},getChildElementContent:function(c,d){var b=this.getChildElementNode(c);var a=null;if(b){a=b.getStringValue()}if(a==null||a==""){a=d}return a},removeChildElement:function(b){var a=this.getChildElementNode(b);a.parentNode.removeChild(a)},addExtension:function(a){if(this.getExtension(a.getElementNS())){this.removeExtension(a.getElementNS())}this.extensions[a.getElementNS()]=a},removeExtension:function(a){this.extensions[a].removeNode();delete this.extensions[a]},getExtensions:function(){var c=[];for(var a in this.extensions){var b=this.extensions[a];if(b instanceof Xmpp4Js.Ext.PacketExtension){c.push(b)}}return c},getExtension:function(a){return this.extensions[a]},loadExtensions:function(d){var c=d.readAll(this);for(var a=0;a<c.length;a++){var b=c[a];this.addExtension(b)}}};Ext.extend(Xmpp4Js.Packet.Base,Ext.util.Observable,Xmpp4Js.Packet.Base.prototype);function createDocument(){return new DOMDocument(new DOMImplementation())}function serializeNode(a){return a.toString()}function parseXmlToDoc(a){return(new DOMImplementation()).loadXML(a)}Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.IQ=function(f,b,a){var e=Xmpp4Js.Packet.getDocument();var c=e.createElement("iq");Xmpp4Js.Packet.IQ.superclass.constructor.call(this,c);if(f){this.setTo(f)}if(b){this.setType(b)}if(a){var d=this.getNode().appendChild(e.createElement("query"));d.setAttribute("xmlns",a)}};Xmpp4Js.Packet.IQ.prototype={setQuery:function(a){this.elem.appendChild(a)},getQuery:function(){var a=this.elem.getElementsByTagName("query").item(0);return a},getQueryXMLNS:function(){var a=this.getQuery();return a?a.getAttribute("xmlns").toString():""}};Ext.extend(Xmpp4Js.Packet.IQ,Xmpp4Js.Packet.Base,Xmpp4Js.Packet.IQ.prototype);Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.Message=function(f,c,a,b){var e=Xmpp4Js.Packet.getDocument();var d=e.createElement("message");Xmpp4Js.Packet.Message.superclass.constructor.call(this,d);if(f){this.setTo(f)}if(c){this.setType(c)}if(a!=null){this.setBody(a)}if(b!=null){this.setSubject(b)}};Xmpp4Js.Packet.Message.prototype={setBody:function(a){this.setChildElementContent("body",a)},getBodyNode:function(){return this.getChildElementNode("body")},getBody:function(){return this.getChildElementContent("body")},setSubject:function(a){this.setChildElementContent("subject",a)},getSubjectNode:function(){return this.getChildElementNode("subject")},getSubject:function(){return this.getChildElementContent("subject")},setThread:function(a){this.setChildElementContent("thread",a)},getThreadNode:function(){return this.getChildElementNode("thread")},getThread:function(){return this.getChildElementContent("thread")},hasContent:function(){var a=this.getBody();return a!=null&&a!=undefined}};Ext.extend(Xmpp4Js.Packet.Message,Xmpp4Js.Packet.Base,Xmpp4Js.Packet.Message.prototype);Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.Presence=function(d,g,b,a,c){var f=Xmpp4Js.Packet.getDocument();var e=f.createElement("presence");Xmpp4Js.Packet.Presence.superclass.constructor.call(this,e);if(g){this.setTo(g)}if(d){this.setType(d)}this.setPresence(a,b,c)};Xmpp4Js.Packet.Presence.prototype={getType:function(){var a=this.elem.getAttribute("type").toString();return a?a:"available"},setStatus:function(a){this.setChildElementContent("status",a)},getStatus:function(){return this.getChildElementContent("status")},setShow:function(a){this.setChildElementContent("show",a)},getShow:function(){return this.getChildElementContent("show","normal")},setPriority:function(a){this.setChildElementContent("priority",a)},getPriority:function(){return this.getChildElementContent("priority","5")},setPresence:function(b,a,c){if(b!=null){this.setShow(b)}if(a!=null){this.setStatus(a)}if(c!=null){this.setPriority(c)}}};Ext.extend(Xmpp4Js.Packet.Presence,Xmpp4Js.Packet.Base,Xmpp4Js.Packet.Presence.prototype);Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.AuthPlainText=function(e,a,c){var d=Xmpp4Js.Packet.getDocument();Xmpp4Js.Packet.AuthPlainText.superclass.constructor.call(this,null,"set","jabber:iq:auth");var b=this.getQuery();b.appendChild(d.createElement("username")).appendChild(d.createTextNode(e));b.appendChild(d.createElement("password")).appendChild(d.createTextNode(a));b.appendChild(d.createElement("resource")).appendChild(d.createTextNode(c));b.appendChild(d.createElement("plaintext"))};Xmpp4Js.Packet.AuthPlainText.prototype={send:function(a){this.setTo(a.domain);a.send(this,function(b){if(b.getType()=="error"){a.fireEvent("autherror")}else{a.jid=b.getTo();a.fireEvent("onconnect");a.fireEvent("onauth")}})}};Ext.extend(Xmpp4Js.Packet.AuthPlainText,Xmpp4Js.Packet.IQ,Xmpp4Js.Packet.AuthPlainText.prototype);Ext.namespace("Xmpp4Js.Packet");Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.Ping=function(c){Xmpp4Js.Packet.Ping.superclass.constructor.call(this,c,"get");var a=Xmpp4Js.Packet.getDocument();var b=a.createElement("ping");b.setAttribute("xmlns","urn:xmpp:ping");this.setQuery(b)};Xmpp4Js.Packet.Ping.prototype={setPing:function(a){this.elem.appendChild(a)},getPing:function(){var a=this.elem.getElementsByTagName("ping").item(0);return a},getPingXMLNS:function(){var a=this.getPing();return a?a.getAttribute("xmlns").toString():""}};Ext.extend(Xmpp4Js.Packet.Ping,Xmpp4Js.Packet.IQ,Xmpp4Js.Packet.Ping.prototype);Ext.namespace("Xmpp4Js.Ext");Xmpp4Js.Ext.PacketExtension=function(a){this.stanza=a};Xmpp4Js.Ext.PacketExtension.prototype={getElementName:function(){return"x"},getElementNS:function(){throw new Error("getElementNS is not defined")},getNode:function(){return this.elem},createNode:function(){var a=this.stanza.getNode().ownerDocument;this.elem=this.stanza.getNode().appendChild(a.createElementNS(this.getElementNS(),this.getElementName()))},readNode:function(){var a=this.stanza.getNode().childNodes;for(var b=0;b<a.getLength();b++){var c=a.item(b);if(c.namespaceURI==this.getElementNS()){this.elem=c;break}}},setNode:function(b){try{this.removeNode()}catch(c){console.info("Couldn't remove child: "+c)}var a=this.stanza.getNode();this.elem=a.appendChild(b)},removeNode:function(){var a=this.stanza.getNode();a.removeChild(this.getNode())}};Xmpp4Js.Ext.PacketExtensionProvider=function(){this.providers=[]};Xmpp4Js.Ext.PacketExtensionProvider.prototype={register:function(b,a){this.providers.push({ns:b,clazz:a})},create:function(c,e){var b=this.get(c);if(!b){throw new Error("No class registered for NS: "+c)}var d=new b(e);var a=Array.prototype.slice.call(arguments);a.shift();a.shift();d.createNode.apply(d,a);return d},read:function(b,d){var a=this.get(b);if(!a){throw new Error("No class registered for NS: "+b)}var c=new a(d);c.readNode();return c},readAll:function(g){var d=[];var b=g.getNode().childNodes;for(var a=0;a<b.getLength();a++){var h=b.item(a);try{var c=this.read(h.namespaceURI,g);d.push(c)}catch(f){console.log("Error reading extension: "+f)}}return d},get:function(b){for(var a=0;a<this.providers.length;a++){var c=this.providers[a];if(c.ns==b){return c.clazz}}}};Xmpp4Js.Ext.ChatStates=function(a){Xmpp4Js.Ext.ChatStates.superclass.constructor.call(this,a)};Xmpp4Js.Ext.ChatStates.XMLNS="http://jabber.org/protocol/chatstates";Xmpp4Js.Ext.ChatStates.prototype={getElementNS:function(){return Xmpp4Js.Ext.ChatStates.XMLNS},getElementName:function(){return this.state},setState:function(b){this.state=b;var c=this.getNode().ownerDocument;var a=c.createElementNS(this.getElementNS(),this.getElementName());this.setNode(a)},getState:function(){return this.state},readNode:function(){Xmpp4Js.Ext.ChatStates.superclass.readNode.call(this);this.state=this.getNode().nodeName},createNode:function(a){if(!a){throw new Error("state must be provided")}this.state=a;Xmpp4Js.Ext.ChatStates.superclass.createNode.call(this)}};Ext.extend(Xmpp4Js.Ext.ChatStates,Xmpp4Js.Ext.PacketExtension,Xmpp4Js.Ext.ChatStates.prototype);Xmpp4Js.Ext.Error=function(c,b,a){this.code=b;this.type=a;Xmpp4Js.Ext.Error.superclass.constructor.call(this,c)};Xmpp4Js.Ext.Error.XMLNS="jabber:client";Xmpp4Js.Ext.Error.prototype={getElementNS:function(){return Xmpp4Js.Ext.Error.XMLNS},getElementName:function(){return"error"},setCode:function(a){this.code=a;this.getNode().setAttribute("code",this.code)},getCode:function(){return this.code},setType:function(a){this.type=type;this.getNode().setAttribute("type",this.type)},getType:function(){return this.type},readNode:function(){Xmpp4Js.Ext.Error.superclass.readNode.call(this);this.code=this.getNode().getAttribute("code").toString();this.type=this.getNode().getAttribute("type").toString()},createNode:function(b,a){if(!b){throw new Error("code must be provided")}if(!a){throw new Error("type must be provided")}this.code=b;this.type=a;Xmpp4Js.Ext.Error.superclass.createNode.call(this)}};Ext.extend(Xmpp4Js.Ext.Error,Xmpp4Js.Ext.PacketExtension,Xmpp4Js.Ext.PacketExtension.prototype);Xmpp4Js.Ext.MessageEvent=function(b,a){Xmpp4Js.Ext.MessageEvent.superclass.constructor.call(this,b);if(a){this.setEvent(a)}};Xmpp4Js.Ext.MessageEvent.XMLNS="jabber:x:event";Xmpp4Js.Ext.MessageEvent.EVENT_EMPTY=null;Xmpp4Js.Ext.MessageEvent.prototype={getElementNS:function(){return Xmpp4Js.Ext.MessageEvent.XMLNS},setEvent:function(b){if(this.event){var a=this.elem.getElementsByTagName(this.event).item(0);this.getNode().removeChild(a)}if(b){this.getNode().appendChild(this.elem.ownerDocument.createElement(b))}this.event=b},getEvent:function(){return this.event},readNode:function(){Xmpp4Js.Ext.MessageEvent.superclass.readNode.call(this);var a=this.getNode().firstChild;this.event=a?a.nodeName:Xmpp4Js.Ext.MessageEvent.EVENT_EMPTY},createNode:function(a){Xmpp4Js.Ext.MessageEvent.superclass.createNode.call(this);if(!a){a=Xmpp4Js.Ext.MessageEvent.EVENT_EMPTY}this.setEvent(a)}};Ext.extend(Xmpp4Js.Ext.MessageEvent,Xmpp4Js.Ext.PacketExtension,Xmpp4Js.Ext.MessageEvent.prototype);Ext.namespace("Xmpp4Js");Xmpp4Js.PacketListenerManager=function(a){this.listeners=[];this.stanzaProvider=a.stanzaProvider};Xmpp4Js.PacketListenerManager.prototype={addPacketListener:function(b,a){if(a===null||a===undefined){a=new Xmpp4Js.PacketFilter.AllPacketFilter()}var c={listener:b,filter:a};this.listeners.push(c);return c},removePacketListener:function(c){var a=-1;for(var b=0;b<this.listeners.length;b++){var d=this.listeners[b];if(d.listener===c){a=b;break}}if(a>-1){this.listeners.splice(a,1)}},run:function(a){a.normalize();for(var c=0;c<this.listeners.length;c++){var h=this.listeners[c];try{if(h.filter instanceof Xmpp4Js.PacketFilter.RawPacketFilter){if(h.filter.accept(a)){h.listener(a)}}else{for(var b=0;b<a.childNodes.getLength();b++){var d=a.childNodes.item(b);if(d.nodeType!=1){continue}if(d.namespaceURI=="http://jabber.org/protocol/httpbind"||d.namespaceURI=="jabber:client"){var g=this.stanzaProvider.fromNode(d);if(h.filter.accept(g)){h.listener(g)}}else{console.info("unrecognized packet namespace: "+d.namespaceURI)}}}}catch(f){console.debug("error during listener")}}}};Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.Registration=function(e,a){Xmpp4Js.Packet.Registration.superclass.constructor.call(this,e,"set","jabber:iq:register");var b=this.getQuery();for(var c in a){var d=b.ownerDocument.createElement(c);d.setTextContent(a[c]);b.appendChild(d)}b.appendChild(b.ownerDocument.createElement("plaintext"))};Xmpp4Js.Packet.Registration.prototype={};Ext.extend(Xmpp4Js.Packet.Registration,Xmpp4Js.Packet.IQ,Xmpp4Js.Packet.Registration.prototype);Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.StanzaProvider=function(){this.providers=[]};Xmpp4Js.Packet.StanzaProvider.prototype={register:function(c,a,b){this.providers.push({qualifier:c,clazz:a,priority:b})},fromNode:function(c){if(!(c instanceof DOMElement)){return undefined}var b=undefined;for(var a=0;a<this.providers.length;a++){var e=this.providers[a];if(e.qualifier(c)&&(b===undefined||e.priority>b.priority)){b=e}}if(b===undefined){throw new NoProviderError(c)}var d=new b.clazz();d.setNode(c);return d},registerDefaultProviders:function(){this.register(Xmpp4Js.Packet.StanzaProvider.BaseProvider,Xmpp4Js.Packet.Base,0);this.register(Xmpp4Js.Packet.StanzaProvider.MessageProvider,Xmpp4Js.Packet.Message,1);this.register(Xmpp4Js.Packet.StanzaProvider.PresenceProvider,Xmpp4Js.Packet.Presence,1);this.register(Xmpp4Js.Packet.StanzaProvider.IQProvider,Xmpp4Js.Packet.IQ,1)}};Xmpp4Js.Packet.StanzaProvider.BaseProvider=function(a){return true};Xmpp4Js.Packet.StanzaProvider._ElemNameProvider=function(a,b){return a.nodeName.toLowerCase()==b.toLowerCase()};Xmpp4Js.Packet.StanzaProvider.IQProvider=function(a){return Xmpp4Js.Packet.StanzaProvider._ElemNameProvider(a,"iq")};Xmpp4Js.Packet.StanzaProvider.PresenceProvider=function(a){return Xmpp4Js.Packet.StanzaProvider._ElemNameProvider(a,"presence")};Xmpp4Js.Packet.StanzaProvider.MessageProvider=function(a){return Xmpp4Js.Packet.StanzaProvider._ElemNameProvider(a,"message")};function NoProviderError(a){this.stanzaNode=a}NoProviderError.prototype={getStanzaNode:function(){return this.stanzaNode}};Ext.extend(NoProviderError,Error,NoProviderError.prototype);Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.PacketHelper=function(a){if(a==null){a=this.createDocument()}this.doc=a};Xmpp4Js.Packet.PacketHelper.prototype.createDocument=function(){return createDocument()};Xmpp4Js.Packet.PacketHelper.prototype.createPacket=function(){var a=this.doc.createElement("body");a.setAttribute("xmlns","http://jabber.org/protocol/httpbind");return a};Xmpp4Js.Packet.PacketHelper.prototype.createIQ=function(c,b,a){return new Xmpp4Js.Packet.IQ(c,b,a)};Xmpp4Js.Packet.PacketHelper.prototype.createMessage=function(d,c,a,b){return new Xmpp4Js.Packet.Message(d,c,a,b)};Xmpp4Js.Packet.PacketHelper.prototype.createPresence=function(e,d,b,a,c){return new Xmpp4Js.Packet.Presence(d,e,b,a,c)};Xmpp4Js.Packet.PacketHelper.prototype.createAuthPlaintext=function(c,a,b){return new Xmpp4Js.Packet.AuthPlainText(c,a,b)};function KeySequence(a){this._initKeys(a)}KeySequence.prototype={getNextKey:function(){if(this._idx<0){return null}return this._keys[this._idx--]},isLastKey:function(){return(this._idx==0)},isFirstKey:function(){return(this._idx==this.getSize()-1)},getSize:function(){return this._keys.length},reset:function(){this._initKeys(this.getSize())},_initKeys:function(c){this._keys=[];this._seed=this._createNewSeed();this._idx=c-1;var b=this._seed;for(var a=0;a<c;a++){this._keys[a]=this._hash(b);b=this._keys[a]}},_createNewSeed:function(){return Math.random()},_hash:function(a){return hex_sha1(a)}};function DelegateManager(){this.map={}}DelegateManager.prototype={add:function(a){var b="delegate_"+Math.random();this.map[b]=a;return b},remove:function(a){delete this.map[a]},fire:function(){var a=arguments;$H(this.map).each(function(c){try{c.value.apply(c.value,a)}catch(b){}})},getMap:function(){return this.map}};function EventListenerManager(){this.events={};this.listenerEvents={}}EventListenerManager.prototype.add=function(b,c){var a=this.events[b];if(a===undefined){this.events[b]=new DelegateManager();a=this.events[b]}var d=a.add(c);this.listenerEvents[d]=b;return d};EventListenerManager.prototype.remove=function(b,c){if(arguments.length==1){c=b;b=this.listenerEvents[c]}var a=this.events[b];if(a===undefined){return}a.remove(c)};EventListenerManager.prototype.getMap=function(b){var a=this.events[b];if(a===undefined){return}return a.getMap()};EventListenerManager.prototype.fireArgs=function(b,a){var c=$A(a);c.unshift(b);this.fire.apply(this,c)};EventListenerManager.prototype.fire=function(c){var a=this.events[c];if(a===undefined){return}var b=$A(arguments);b.shift();a.fire.apply(a,b)};Ext.namespace("Xmpp4Js.Transport");Xmpp4Js.Transport.BOSH=function(a){this.domain=a.domain;this.server=a.server||a.domain;this.port=a.port||5222;this.wait=a.wait||60;this.listeners=a.listeners;this.isSessionOpen=false;this.taskRunner=new Ext.util.TaskRunner();this.sendQueueTask={scope:this,run:this.sendQueue,interval:500};this.sendPollTask={scope:this,run:this.sendPoll,interval:500};this.queue=[];this.endpoint=a.endpoint;this.xhr=this.createXhr();this.openRequestCount=0;this.sid=null;this.rid=null;this.keySeq=null;this.maxRequests=null;this.hold=null;var b=Ext.apply(a,{});this.addEvents({recv:true,write:true,error:true,termerror:true,beginsession:true,endsession:true});Xmpp4Js.Transport.BOSH.superclass.constructor.call(this,b)};Xmpp4Js.Transport.BOSH.prototype={createXhr:function(){return new Ext.data.Connection({url:this.endpoint,method:"POST",timeout:this.wait*1000,disableCaching:true,headers:{"content-type":"text/xml"}})},beginSession:function(){this.rid=this.createInitialRid();var a=this.createPacketNode();a.setAttribute("wait",this.wait);a.setAttribute("to",this.domain);a.setAttribute("route","xmpp:"+this.server+":"+this.port);a.setAttribute("ver","1.6");a.setAttribute("xml:lang","en");a.setAttribute("xmlns:xmpp","urn:xmpp:xbosh");a.setAttribute("xmpp:version","1.0");this.on("recv",this.onBeginSessionResponse,this,{single:true});this.write(a)},onBeginSessionResponse:function(a){this.sid=a.getAttribute("sid").toString();this.maxRequests=a.getAttribute("requests").toString();if(a.hasAttribute("hold")){this.hold=a.getAttribute("hold").toString()}else{this.hold=a.maxRequests-1}if(a.hasAttribute("wait")){this.wait=a.getAttribute("wait").toString()}this.startup();this.fireEvent("beginsession")},startup:function(){this.isSessionOpen=true;this.taskRunner.start(this.sendQueueTask);this.taskRunner.start(this.sendPollTask)},endSession:function(){var a=this.createPacketNode();a.setAttribute("type","terminate");this.shutdown();this.write(a);this.fireEvent("endsession")},shutdown:function(){this.isSessionOpen=false;this.taskRunner.stop(this.sendQueueTask);this.taskRunner.stop(this.sendPollTask)},send:function(a){this.queue.push(a)},write:function(a){this.addFrameData(a);var b=a.toString();this.fireEvent("write",a);this.openRequestCount++;this.xhr.request({xmlData:b,xmlNode:a,scope:this,callback:this.onWriteResponse})},onWriteResponse:function(c,f,b){this.openRequestCount--;var a=null;if(b.responseText!=null){a=new DOMImplementation().loadXML(b.responseText).documentElement}if(b.status==-1){}else{if(!f||b.status!=200){this.shutdown();var g=null;if(a!=null){g=a.getAttribute("condition").toString()}else{if(!b.status){g="undefined-condition"}else{if(b.status!=200){g="status."+b.status}else{g="undefined-condition"}}}var e=Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.conditions[g].title;var d=Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.conditions[g].message;this.fireEvent("termerror",e,d,a)}else{if(a.getAttribute("type").toString()=="error"){this.fireEvent("error",a)}else{this.fireEvent("recv",a)}}}},createPacketNode:function(){var a=DomBuilder.node("body",{xmlns:"http://jabber.org/protocol/httpbind"});return a},sendPoll:function(){if(this.openRequestCount==0&&this.queue.length==0){var a=this.createPacketNode();this.write(a)}},sendQueue:function(){if(this.queue.length==0||this.openRequestCount>this.maxRequests){return}var a=this.createPacketNode();while(this.queue.length>0){var c=this.queue.shift();var b=a.ownerDocument.importNode(c,true);a.appendChild(b)}this.write(a)},addSid:function(a){if(this.sid!==null){a.setAttribute("sid",this.sid)}},addRid:function(a){if(this.rid!==null){a.setAttribute("rid",this.rid++)}},addKey:function(a){if(this.keySeq instanceof KeySequence){var d=this.keySeq;var b=d.isFirstKey();var e=d.isLastKey();var c=d.getNextKey();if(b){a.setAttribute("newkey",c)}else{a.setAttribute("key",c)}if(e){console.info("Resetting KeySequence");d.reset();var f=d.getNextKey();a.setAttribute("newkey",f)}}},addFrameData:function(a){this.addRid(a);this.addSid(a);this.addKey(a)},createInitialRid:function(){return Math.floor(Math.random()*10000)}};Ext.extend(Xmpp4Js.Transport.BOSH,Ext.util.Observable,Xmpp4Js.Transport.BOSH.prototype);Ext.namespace("Xmpp4Js.PacketFilter");Xmpp4Js.PacketFilter.PacketFilter=function(){};Xmpp4Js.PacketFilter.PacketFilter.prototype={accept:function(a){return true}};Xmpp4Js.PacketFilter.RawPacketFilter=function(){};Xmpp4Js.PacketFilter.RawPacketFilter.prototype={accept:function(a){return true}};Ext.extend(Xmpp4Js.PacketFilter.RawPacketFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.RawPacketFilter.prototype);Xmpp4Js.PacketFilter.CompositeFilter=function(){this.filters=[];for(var a=0;a<arguments.length;a++){this.filters.push(arguments[a])}};Xmpp4Js.PacketFilter.CompositeFilter.prototype={accept:function(a){return false}};Ext.extend(Xmpp4Js.PacketFilter.CompositeFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.CompositeFilter.prototype);Xmpp4Js.PacketFilter.AndFilter=function(){Xmpp4Js.PacketFilter.AndFilter.superclass.constructor.apply(this,arguments)};Xmpp4Js.PacketFilter.AndFilter.prototype={accept:function(c){var b=true;for(var a=0;a<this.filters.length;a++){b=b&&this.filters[a].accept(c)}return b}};Ext.extend(Xmpp4Js.PacketFilter.AndFilter,Xmpp4Js.PacketFilter.CompositeFilter,Xmpp4Js.PacketFilter.AndFilter.prototype);Xmpp4Js.PacketFilter.OrFilter=function(){Xmpp4Js.PacketFilter.OrFilter.superclass.constructor.apply(this,arguments)};Xmpp4Js.PacketFilter.OrFilter.prototype={accept:function(c){var b=false;for(var a=0;a<this.filters.length;a++){b=b||this.filters[a].accept(c)}return b}};Ext.extend(Xmpp4Js.PacketFilter.OrFilter,Xmpp4Js.PacketFilter.CompositeFilter,Xmpp4Js.PacketFilter.OrFilter.prototype);Xmpp4Js.PacketFilter.AllPacketFilter=function(){Xmpp4Js.PacketFilter.AllPacketFilter.superclass.constructor.apply(this,arguments)};Xmpp4Js.PacketFilter.AllPacketFilter.prototype={accept:function(a){return true}};Ext.extend(Xmpp4Js.PacketFilter.AllPacketFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.AllPacketFilter.prototype);Xmpp4Js.PacketFilter.PacketTypeFilter=function(a){Xmpp4Js.PacketFilter.PacketTypeFilter.superclass.constructor.apply(this,arguments);this.type=a};Xmpp4Js.PacketFilter.PacketTypeFilter.prototype={accept:function(a){return a instanceof (this.type)}};Ext.extend(Xmpp4Js.PacketFilter.PacketTypeFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.PacketTypeFilter.prototype);Xmpp4Js.PacketFilter.PacketIdFilter=function(a){Xmpp4Js.PacketFilter.PacketIdFilter.superclass.constructor.apply(this,arguments);this.id=a};Xmpp4Js.PacketFilter.PacketIdFilter.prototype={accept:function(a){return a.getId()==this.id}};Ext.extend(Xmpp4Js.PacketFilter.PacketIdFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.PacketIdFilter.prototype);Xmpp4Js.PacketFilter.FromContainsFilter=function(a){Xmpp4Js.PacketFilter.FromContainsFilter.superclass.constructor.apply(this,arguments);this.match=a};Xmpp4Js.PacketFilter.FromContainsFilter.prototype={accept:function(a){return a.getFrom().match(this.match)}};Ext.extend(Xmpp4Js.PacketFilter.FromContainsFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.FromContainsFilter.prototype);Xmpp4Js.PacketFilter.IQQueryNSFilter=function(a){Xmpp4Js.PacketFilter.IQQueryNSFilter.superclass.constructor.apply(this,arguments);this.iqFilter=new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.IQ);this.namespace=a};Xmpp4Js.PacketFilter.IQQueryNSFilter.prototype={accept:function(a){return this.iqFilter.accept(a)&&a.getQuery()!=null&&a.getQuery().namespaceURI==this.namespace}};Ext.extend(Xmpp4Js.PacketFilter.IQQueryNSFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.IQQueryNSFilter.prototype);Ext.namespace("Xmpp4Js.PacketFilter");Xmpp4Js.PacketFilter.TerminalErrorPacketFilter=function(){};Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.conditions={"bad-request":{title:"bad-request",message:"The format of an HTTP header or binding element received from the client is unacceptable (e.g., syntax error), or Script Syntax is not supported."},"status.400":{title:"bad-request",message:"The format of an HTTP header or binding element received from the client is unacceptable (e.g., syntax error), or Script Syntax is not supported."},"host-gone":{title:"host-gone",message:"The target domain specified in the 'to' attribute or the target host or port specified in the 'route' attribute is no longer serviced by the connection manager."},"host-unknown":{title:"host-unknown",message:"The target domain specified in the 'to' attribute or the target host or port specified in the 'route' attribute is unknown to the connection manager."},"improper-addressing":{title:"improper-addressing",message:"The initialization element lacks a 'to' or 'route' attribute (or the attribute has no value) but the connection manager requires one."},"internal-server-error":{title:"internal-server-error",message:"The connection manager has experienced an internal error that prevents it from servicing the request."},"item-not-found":{title:"item-not-found*",message:"(1) 'sid' is not valid, (2) 'stream' is not valid, (3) 'rid' is larger than the upper limit of the expected window, (4) connection manager is unable to resend response, (5) 'key' sequence is invalid"},"status.404":{title:"item-not-found*",message:"(1) 'sid' is not valid, (2) 'stream' is not valid, (3) 'rid' is larger than the upper limit of the expected window, (4) connection manager is unable to resend response, (5) 'key' sequence is invalid"},"other-request":{title:"other-request",message:"Another request being processed at the same time as this request caused the session to terminate."},"policy-violation":{title:"policy-violation",message:"The client has broken the session rules (polling too frequently, requesting too frequently, too many simultaneous requests)."},"status.403":{title:"policy-violation",message:"The client has broken the session rules (polling too frequently, requesting too frequently, too many simultaneous requests)."},"remote-connection-failed":{title:"remote-connection-failed",message:"The connection manager was unable to connect to, or unable to connect securely to, or has lost its connection to, the server."},"remote-stream-error":{title:"remote-stream-error",message:"Encapsulates an error in the protocol being transported."},"see-other-uri":{title:"see-other-uri",message:"The connection manager does not operate at this URI (e.g., the connection manager accepts only SSL or TLS connections at some https: URI rather than the http: URI requested by the client). The client may try POSTing to the URI in the content of the <uri/> child element."},"system-shutdown":{title:"system-shutdown",message:"The connection manager is being shut down. All active HTTP sessions are being terminated. No new sessions can be created."},"undefined-condition":{title:"undefined-condition",message:"The error is not one of those defined herein; the connection manager SHOULD include application-specific information in the content of the <body/> wrapper."}};Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.prototype={accept:function(a){return a.getAttribute("type").toString()=="terminate"&&Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.conditions[a.getAttribute("condition").toString()]!=undefined}};Ext.extend(Xmpp4Js.PacketFilter.TerminalErrorPacketFilter,Xmpp4Js.PacketFilter.RawPacketFilter,Xmpp4Js.PacketFilter.TerminalErrorPacketFilter.prototype);Xmpp4Js.PacketFilter.RecoverableErrorPacketFilter=function(){};Xmpp4Js.PacketFilter.RecoverableErrorPacketFilter.prototype={accept:function(a){return a.getAttribute("type").toString()=="error"}};Ext.extend(Xmpp4Js.PacketFilter.RecoverableErrorPacketFilter,Xmpp4Js.PacketFilter.RawPacketFilter,Xmpp4Js.PacketFilter.RecoverableErrorPacketFilter.prototype);Ext.namespace("Xmpp4Js.PacketFilter");Xmpp4Js.PacketFilter.ExtensionFilter=function(a){Xmpp4Js.PacketFilter.ExtensionFilter.superclass.constructor.apply(this,arguments);this.extensionNS=a};Xmpp4Js.PacketFilter.ExtensionFilter.prototype={accept:function(c){var b=c.getNode();for(var a=0;a<b.childNodes.getLength();a++){if(b.childNodes.item(a).namespaceURI==this.extensionNS){return true}}}};Ext.extend(Xmpp4Js.PacketFilter.ExtensionFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.PacketFilter.ExtensionFilter.prototype);function Md5Sasl(c,a,b){this._username=c;this._password=a;this._domain=b;this.reset()}Md5Sasl.prototype={reset:function(){this._nc=null;this._nonce=null;this._cnonce=null;this._digestUri=null;this._qop="auth";this._charset="utf-8";this._realm=null},decodeChallenge:function(a){return atob(a)},encodeResponse:function(a){return binb2b64(str2binb(a))},computeChallengeResponse:function(c){var a=this.deserializeFields(this.decodeChallenge(c));this._nc="00000001";this._nonce=a.nonce;this._cnonce=this._generateCnonce();this._digestUri="xmpp/"+this._domain;this._realm=a.realm||this._domain;var b=this._computeResponse(false);var d={username:this._username,realm:this._realm,nonce:this._nonce,cnonce:this._cnonce,nc:this._nc,qop:this._qop,"digest-uri":this._digestUri,response:b,charset:this._charset};return this.encodeResponse(this.serializeFields(d))},checkResponse:function(b){var a=this.deserializeFields(this.decodeChallenge(b));var c=this._computeResponse(true);return(c==a.rspauth)},deserializeFields:function(b){var a={};var g=/\s*([^\=]+)\=\"?([^\"\,]*)\"?\,?\s*/g;var e=b.split(g);for(var f=0;f<e.length-1;f+=3){var d=e[f+1];var c=e[f+2];a[d]=c}return a},serializeFields:function(a){var d=[];for(var c in a){var b=a[c];d.push(c+'="'+b+'"')}return d.join(",")},_computeResponse:function(e){var a=[this._username,this._domain,this._password].join(":");var d=[str_md5(a),this._nonce,this._cnonce].join(":");var c=(e?"":"AUTHENTICATE")+":"+this._digestUri;var b=hex_md5([hex_md5(d),this._nonce,this._nc,this._cnonce,this._qop,hex_md5(c)].join(":"));return b},_generateCnonce:function(){return cnonce(14)}};function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var b=new Array;var g=String.fromCharCode(237);if(g.charCodeAt(0)<0){for(var f=0;f<a.length;f++){var e=a.charCodeAt(f);if(e>0){b[b.length]=e}else{b[b.length]=(((256+e)>>6)|192);b[b.length]=(((256+e)&63)|128)}}}else{for(var f=0;f<a.length;f++){var e=a.charCodeAt(f);if(e<128){b[b.length]=e}else{if((e>127)&&(e<2048)){b[b.length]=((e>>6)|192);b[b.length]=((e&63)|128)}else{b[b.length]=((e>>12)|224);b[b.length]=(((e>>6)&63)|128);b[b.length]=((e&63)|128)}}}}return b}function utf8d2t(c){var b=new Array;var a=0;while(a<c.length){if(c[a]<128){b[b.length]=String.fromCharCode(c[a]);a++}else{if((c[a]>191)&&(c[a]<224)){b[b.length]=String.fromCharCode(((c[a]&31)<<6)|(c[a+1]&63));a+=2}else{b[b.length]=String.fromCharCode(((c[a]&15)<<12)|((c[a+1]&63)<<6)|(c[a+2]&63));a+=3}}}return b.join("")}function b64arrays(){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array();f64=new Array();for(var a=0;a<b.length;a++){b64[a]=b.charAt(a);f64[b.charAt(a)]=a}}function b64d2t(f){var e=new Array;var c=0;var a=f.length;if((a%3)==1){f[f.length]=0;f[f.length]=0}if((a%3)==2){f[f.length]=0}while(c<f.length){e[e.length]=b64[f[c]>>2];e[e.length]=b64[((f[c]&3)<<4)|(f[c+1]>>4)];e[e.length]=b64[((f[c+1]&15)<<2)|(f[c+2]>>6)];e[e.length]=b64[f[c+2]&63];if((c%57)==54){e[e.length]="\n"}c+=3}if((a%3)==1){e[e.length-1]=e[e.length-2]="="}if((a%3)==2){e[e.length-1]="="}var b=e.join("");return b}function b64t2d(b){var c=new Array;var a=0;b=b.replace(/\n|\r/g,"");b=b.replace(/=/g,"");while(a<b.length){c[c.length]=(f64[b.charAt(a)]<<2)|(f64[b.charAt(a+1)]>>4);c[c.length]=(((f64[b.charAt(a+1)]&15)<<4)|(f64[b.charAt(a+2)]>>2));c[c.length]=(((f64[b.charAt(a+2)]&3)<<6)|(f64[b.charAt(a+3)]));a+=4}if(b.length%4==2){c=c.slice(0,c.length-2)}if(b.length%4==3){c=c.slice(0,c.length-1)}return c}if(typeof(atob)=="undefined"||typeof(btoa)=="undefined"){b64arrays()}if(typeof(atob)=="undefined"){atob=function(a){return utf8d2t(b64t2d(a))}}if(typeof(btoa)=="undefined"){btoa=function(a){return b64d2t(utf8t2d(a))}}function cnonce(b){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var d="";for(var a=0;a<b;a++){d+=c.charAt(Math.round(Math.random(new Date().getTime())*(c.length-1)))}return d}Ext.namespace("Xmpp4Js");Xmpp4Js.Connection=function(a){this.transport=null;this.id=Ext.id();this.stanzaProvider=a.stanzaProvider;this.transportConfig=a.transport;var b=Ext.apply(a,{});this.addEvents({connect:true,close:true,error:true});this.listeners=a.listeners;this.domain=null;this.connected=false;this.packetHelper=new Xmpp4Js.Packet.PacketHelper();this.packetListenerManager=new Xmpp4Js.PacketListenerManager({stanzaProvider:this.stanzaProvider});Xmpp4Js.Connection.superclass.constructor.call(this,b)};Xmpp4Js.Connection.prototype={connect:function(c,b,d){if(this.isConnected()){throw new Xmpp4Js.Error("Already Connected")}this.domain=c;var a=this.transportConfig.clazz;if(typeof a!="function"){throw new Error("transportClass is not valid.")}var e=Ext.apply(this.transportConfig,{domain:this.domain,port:b,server:d,listeners:{scope:this,termerror:this.onTerminalError,error:this.onError,beginsession:this.onBeginSession,endsession:this.onEndSession}});this.transport=new a(e);this.transport.beginSession()},close:function(){if(!this.isConnected()){throw new Xmpp4Js.Error("Not Connected")}this.transport.endSession()},send:function(c,e){if(!this.isConnected()){throw new Xmpp4Js.Error("Not Connected")}if(e){var d=c.getId();var a=new Xmpp4Js.PacketFilter.PacketIdFilter(d);var b=function(f){this.removePacketListener(b);e(f)}.bind(this);this.addPacketListener(b,a)}this.transport.send(c.getNode())},isConnected:function(){return this.connected},addPacketListener:function(b,a){return this.packetListenerManager.addPacketListener(b,a)},removePacketListener:function(a){return this.packetListenerManager.removePacketListener(a)},onRecv:function(a){this.packetListenerManager.run(a)},onTerminalError:function(c,b,a){this.fireEvent("error",true,a,c,b);this.shutdown()},onError:function(a){this.fireEvent("error",false,a)},onBeginSession:function(){this.startup()},onEndSession:function(){this.shutdown()},shutdown:function(){this.transport.un("recv",this.onRecv,this);this.connected=false;this.fireEvent("close")},startup:function(){this.connected=true;this.transport.on({scope:this,recv:this.onRecv});this.fireEvent("connect")},getPacketHelper:function(){return this.packetHelper},getJid:function(){return new Xmpp4Js.Jid(this.jid)}};Ext.extend(Xmpp4Js.Connection,Ext.util.Observable,Xmpp4Js.Connection.prototype);Ext.namespace("Xmpp4Js.Chat");Xmpp4Js.Chat.Chat=function(b,c,a){c=new Xmpp4Js.Jid(c);this.chatMan=b;this.participant=c;this.thread=a;this.addEvents({messageReceived:true,messageSent:true,close:true})};Xmpp4Js.Chat.Chat.prototype={sendMessage:function(c){if(!(c instanceof Xmpp4Js.Packet.Message)){c=this.createMessage(c)}var a=this.getParticipant().withoutResource();c.setToJid(a);c.setThread(this.getThread());this.chatMan.getConnection().send(c);var b=c.getBody();this.fireEvent("messageSent",this,c)},getOutgoingJid:function(){return this.chatMan.getConnection().getJid()},createMessage:function(b){var a=this.chatMan.getConnection().getPacketHelper();var b=a.createMessage(this.participant,"chat",b);b.setThread(this.getThread());return b},getParticipant:function(){return this.participant},getThread:function(){if(!this.thread){this.thread=Math.random()}return this.thread},close:function(){this.chatMan.closeChat(this)}};Ext.extend(Xmpp4Js.Chat.Chat,Ext.util.Observable,Xmpp4Js.Chat.Chat.prototype);Ext.namespace("Xmpp4Js.Chat");Xmpp4Js.Chat.MessageThreadFilter=function(a){this.thread=a;this.packetTypeFilter=new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.Message)};Xmpp4Js.Chat.MessageThreadFilter.prototype={accept:function(a){return this.packetTypeFilter.accept(a)&&a.getThread()==this.thread}};Ext.extend(Xmpp4Js.Chat.MessageThreadFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.Chat.MessageThreadFilter.prototype);Ext.namespace("Xmpp4Js.Chat");Xmpp4Js.Chat.ChatManager=function(a){var b=Ext.apply(a,{});this.con=a.con;this.threads={};this.chats=[];this.addEvents({chatStarted:true,messageReceived:true,chatClosed:true});this.listeners=a.listeners;Xmpp4Js.Chat.ChatManager.superclass.constructor.call(this,b);this._registerEvents()};Xmpp4Js.Chat.ChatManager.prototype={options:{ignoreResource:false,ignoreThread:false},_registerEvents:function(){this.con.addPacketListener(function(a){this._handleMessageReceived(a)}.bind(this),new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.Message))},_handleMessageReceived:function(f){if(f.getType()!="normal"&&f.getType()!="chat"){return}var b=null;var c=f.getFromJid();var a=f.getThread();try{b=this.findBestChat(c,a)}catch(d){b=this.createChat(c,a)}this.fireEvent("messageReceived",b,f);b.fireEvent("messageReceived",b,f)},createChat:function(c,a,d){var b=new Xmpp4Js.Chat.Chat(this,c,a);this.threads[b.getThread()]=b;this.chats.push(b);this.fireEvent("chatStarted",b);if(d instanceof Function){b.on("messageReceived",d)}return b},closeChat:function(a){for(var b=0;b<this.chats.length;b++){if(a==this.chats[b]){this.chats=this.chats.slice(b,b);break}}delete this.threads[a.getThread()];a.fireEvent("close",a);this.fireEvent("chatClosed",a)},getThreadChat:function(a){return this.threads[a]},getUserChat:function(c){for(var b=0;b<this.chats.length;b++){var a=this.chats[b];if(a.getParticipant().equals(c,this.options.ignoreResource)){return a}}},findBestChat:function(d,a){var b=null;var c=new Xmpp4Js.Jid(d);if(a&&!this.options.ignoreThread){b=this.getThreadChat(a)}else{b=this.getUserChat(c)}if(b==null){console.log("Could not find best chat for user/thread combination: ");console.dir(arguments);throw new Error("Could not find best chat for user/thread combination.")}return b},setOptions:function(a){this.options=a},getOptions:function(){return this.options},getConnection:function(){return this.con}};Xmpp4Js.Chat.ChatManager.instances={};Xmpp4Js.Chat.ChatManager.getInstanceFor=function(b){var c=Xmpp4Js.Chat.ChatManager.instances;var a=b.con;if(c[a.id]===undefined){c[a.id]=new Xmpp4Js.Chat.ChatManager(b)}return c[a.id]};Ext.extend(Xmpp4Js.Chat.ChatManager,Ext.util.Observable,Xmpp4Js.Chat.ChatManager.prototype);Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.RosterEntry=function(c,b,d,f,a,e){this.jid=c;this.alias=b;this.subscription=d;this.ask=f;this.groups=a;this.roster=e};Xmpp4Js.Roster.RosterEntry.prototype={update:function(b,c,d,a){this.alias=b;this.subscription=c;this.ask=d;this.groups=a},getGroups:function(){var a=[];if(this.groups.length==0){a.push(this.roster.getUnfiledContacts())}else{$A(this.groups).each(function(c){var b=this.roster.getGroup(c);if(b==undefined){b=new Xmpp4Js.Roster.VirtualRosterGroup(c,[this],this.roster)}a.push(b)}.bind(this))}return a}};Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.RosterGroup=function(a,b){this.name=a;this.roster=b};Xmpp4Js.Roster.RosterGroup.prototype={getEntries:function(){var a=[];$H(this.roster.map).each(function(f){var d=f.value;var b=d.groups;for(var c=0;c<b.length;c++){var e=b[c];if(e==this.name){a.push(d)}}}.bind(this));return a},getEntry:function(b){var a=this.getEntries();var c=undefined;$A(a).each(function(d){if(d.jid==b){c=d}}.bind(this));return c}};Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.VirtualRosterGroup=function(c,a,b){Xmpp4Js.Roster.VirtualRosterGroup.superclass.constructor.call(this,c,b);this.entries=a};Xmpp4Js.Roster.VirtualRosterGroup.prototype={getEntries:function(){return this.entries}};Ext.extend(Xmpp4Js.Roster.VirtualRosterGroup,Xmpp4Js.Roster.RosterGroup,Xmpp4Js.Roster.VirtualRosterGroup.prototype);Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.UnfiledEntriesRosterGroup=function(a){Xmpp4Js.Roster.VirtualRosterGroup.superclass.constructor.call(this,"Unfiled Contacts",[],a)};Xmpp4Js.Roster.UnfiledEntriesRosterGroup.prototype={getEntries:function(){var a=[];$H(this.roster.map).each(function(d){var c=d.value;var b=c.groups;if(!b||b.length==0){a.push(c)}}.bind(this));return a}};Ext.extend(Xmpp4Js.Roster.UnfiledEntriesRosterGroup,Xmpp4Js.Roster.VirtualRosterGroup,Xmpp4Js.Roster.UnfiledEntriesRosterGroup.prototype);Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.RosterItemManager=function(){this.map={};this.addEvents({add:true,update:true,remove:true})};Xmpp4Js.Roster.RosterItemManager.prototype={get:function(a){a=new Xmpp4Js.Jid(a).withoutResource().toString();return this.map[a]},getGroup:function(b){var a=this.getGroups();for(var c=0;c<a.length;c++){if(a[c].name==b){return a[c]}}},getGroups:function(){var a=[];var b={};a.push(this.getUnfiledContacts());$H(this.map).each(function(d){var c=d.value;$A(c.groups).each(function(e){if(b[e]==undefined){b[e]=1;a.push(new Xmpp4Js.Roster.RosterGroup(e,this))}}.bind(this))}.bind(this));return a},getUnfiledContacts:function(){return new Xmpp4Js.Roster.UnfiledEntriesRosterGroup(this)},update:function(d,c,e,g,a){d=new Xmpp4Js.Jid(d).withoutResource().toString();if(e=="remove"){this.remove(d);return}var f=new Xmpp4Js.Roster.RosterEntry(d,c,e,g,a,this);var b=this.map[d];this.map[d]=f;if(b==undefined){this.fireEvent("add",f)}else{this.fireEvent("update",b,f)}return f},remove:function(a){var b=this.map[a];this.fireEvent("remove",b);delete this.map[a]},rosterPacketListener:function(b){var l=b.getQuery().getElementsByTagName("item");for(var k=0;k<l.getLength();k++){var m=l.item(k);var c=m.getAttribute("jid").toString();var a=m.getAttribute("name").toString();var n=m.getAttribute("subscription").toString();var h=m.getAttribute("ask").toString();var d=[];var g=m.getElementsByTagName("group");for(var f=0;f<g.getLength();f++){var e=g.item(f);d.push(e.getStringValue())}this.update(c,a,n,h,d)}},rosterSubSyncPacketListener:function(l){var b=l.getNode().getElementsByTagNameNS("http://jabber.org/protocol/roster-subsync","x").item(0);if(!b){return}var c=l.getFrom();var m=b.getElementsByTagName("item");for(var k=0;k<m.getLength();k++){var n=m.item(k);var a=n.getAttribute("name").toString();var o=n.getAttribute("subscription").toString();var h=n.getAttribute("ask").toString();var d=[];var g=n.getElementsByTagName("group");for(var f=0;f<g.getLength();f++){var e=g.item(f);d.push(e.getStringValue())}this.update(c,a,o,h,d)}}};Ext.extend(Xmpp4Js.Roster.RosterItemManager,Ext.util.Observable,Xmpp4Js.Roster.RosterItemManager.prototype);Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.PresenceManager=function(){this.map={};this.best={};this.getBestImpl=new Xmpp4Js.Roster.PresenceManager.GetBestImpl();this.addEvents({update:true})};Xmpp4Js.Roster.PresenceManager.prototype={update:function(d){var a=d.getFromJid().withoutResource().toString();var c=d.getFromJid().getResource();var b=d.getType();if(b!="available"&&b!="unavailable"){throw new Error("Invalid prsence type: "+b)}if(this.map[a]==undefined){this.map[a]={}}this.map[a][c]=d;this.fireEvent("update",d);delete this.best[a]},get:function(a,b){if(!b){return this.getBest(a)}return this.map[a]?this.map[a][b]:undefined},getBest:function(b){var a=this.map[b];this.best[b]=this.getBestImpl.getBest(a);return this.best[b]},remove:function(a,b){if(this.map[a]==undefined){return}if(!b){$H(this.map[a]).each(function(d){var c=d.value;this.remove(a,c)}.bind(this));delete this.map[a]}else{if(this.map[a][b]==undefined){return}this.fireEvent("remove",this.map[a][b]);delete this.map[a][b]}},presencePacketListener:function(b){try{this.update(b)}catch(a){}}};Ext.extend(Xmpp4Js.Roster.PresenceManager,Ext.util.Observable,Xmpp4Js.Roster.PresenceManager.prototype);Xmpp4Js.Roster.PresenceManager.GetBestImpl=function(){};Xmpp4Js.Roster.PresenceManager.GetBestImpl.prototype={SHOW_WEIGHT:{chat:6,normal:5,away:4,xa:3,dnd:2},TYPE_WEIGHT:{available:5,unavailable:1},getBest:function(b){var a=undefined;var c=0;$H(b).each(function(i){var f=i.value;var d=f.getShow();var g=f.getType();var e=f.getPriority();var h=this.SHOW_WEIGHT[d]*this.TYPE_WEIGHT[g]*e;if(a==null||h>c){a=f;c=h}}.bind(this));return a}};Ext.namespace("Xmpp4Js.Roster");Xmpp4Js.Roster.Roster=function(a){this.presenceManager=new Xmpp4Js.Roster.PresenceManager();this.rosterItemManager=new Xmpp4Js.Roster.RosterItemManager(this);this.con=a;this.con.addPacketListener(this.rosterItemManager.rosterPacketListener.bind(this.rosterItemManager),new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.RosterPacket));this.con.addPacketListener(this.rosterItemManager.rosterSubSyncPacketListener.bind(this.rosterItemManager),new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.Presence));this.con.addPacketListener(this.presenceManager.presencePacketListener.bind(this.presenceManager),new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.Presence))};Xmpp4Js.Roster.Roster.prototype={reload:function(){var a=this.con.getPacketHelper().createIQ(null,"get","jabber:iq:roster");this.con.send(a)},getEntry:function(a){return this.rosterItemManager.get(a)},getGroup:function(a){return this.rosterItemManager.getGroup(a)},getGroups:function(){return this.rosterItemManager.getGroups()},getUnfiledEntries:function(){return this.rosterItemManager.getUnfiledContacts()},add:function(c,b,a){var d=new Xmpp4Js.Packet.RosterPacket();d.addItem(c,b,a);this.con.send(d,function(f){if(f.getType()=="error"){}var e=this.con.getPacketHelper().createPresence(c,"subscribe");this.con.send(e)}.bind(this))},remove:function(a){var b=new Xmpp4Js.Packet.RosterPacket();b.addItem(a,null,null,"remove");this.con.send(b)},createEntry:function(c,b,a){return this.add.apply(this,arguments)},getPresence:function(a,b){return this.presenceManager.get(a,b)},getRosterItemManager:function(){return this.rosterItemManager},getPresenceManager:function(){return this.presenceManager},getConnection:function(){return this.con}};Xmpp4Js.Roster.Roster.instances={};Xmpp4Js.Roster.Roster.getInstanceFor=function(a){var b=Xmpp4Js.Roster.Roster.instances;if(b[a.id]===undefined){b[a.id]=new Xmpp4Js.Roster.Roster(a)}return b[a.id]};Ext.namespace("Xmpp4Js.Packet");Xmpp4Js.Packet.RosterPacket=function(a){Xmpp4Js.Packet.RosterPacket.superclass.constructor.call(this,null,"set","jabber:iq:roster")};Xmpp4Js.Packet.RosterPacket.prototype={addItem:function(b,e,c,k){var g=Xmpp4Js.Packet.getDocument();this.setId("roster_add");var f=this.getQuery();var j=f.appendChild(g.createElement("item"));j.setAttribute("xmlns","jabber:iq:roster");j.setAttribute("jid",b);if(k){j.setAttribute("subscription",k)}if(e){j.setAttribute("alias",e)}if(c){for(var d=0;d<c.length;d++){var h=c[d];var a=j.appendChild(g.createElement("group"));a.setAttribute("xmlns","jabber:iq:roster");a.setTextContent(h)}}}};Ext.extend(Xmpp4Js.Packet.RosterPacket,Xmpp4Js.Packet.IQ,Xmpp4Js.Packet.RosterPacket.prototype);function RosterPacketProvider(b){if(!Xmpp4Js.Packet.StanzaProvider.IQProvider(b)){return false}var a=b.getElementsByTagName("query").item(0);return a!=undefined&&a.namespaceURI=="jabber:iq:roster"}Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.MucParticipant=function(c,b,a){this.room=c;this.confJid=b;this.realJid=a;this.status=[]};Xmpp4Js.Muc.MucParticipant.Status={VISIBLE_JID:"100",ENTER_ROOM:"201",SELF:"110",CHANGED_NICK:"210"};Xmpp4Js.Muc.MucParticipant.prototype={getNick:function(){return this.confJid.getResource()},getRealJid:function(){return this.realJid},getConfJid:function(){return this.confJid},getStatus:function(){return this.status},isSelf:function(){var a=this.getStatus();for(var b in a){var c=a[b];if(c==Xmpp4Js.Muc.MucParticipant.Status.SELF){return true}}return false},_getMucManager:function(){return this.room._getMucManager()}};Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.MucRoom=function(c,a,b){this.mucMan=c;this.roomJid=a;this.name=b};Xmpp4Js.Muc.MucRoom.prototype={getRoomJid:function(){return this.roomJid},createState:function(){var a=new Xmpp4Js.Muc.StatefulMucRoom(this);return a},_getMucManager:function(){return this.mucMan}};Ext.extend(Xmpp4Js.Muc.MucRoom,Ext.util.Observable,Xmpp4Js.Muc.MucRoom.prototype);Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.StatefulMucRoom=function(a){this.mucMan=a.mucMan;this.roomJid=a.roomJid;this.name=a.name;this._myNick=null;this.addEvents({join:true,error:true,part:true})};Xmpp4Js.Muc.StatefulMucRoom.prototype={getParticipants:function(a){if(!this.isJoined()){throw new Xmpp4Js.Muc.MucError("Not in a room")}var c=this._getMucManager()._getConnection().getServiceDisco();var b=this;c.discoverItems(this.roomJid,function(e,d){var f=[];for(var g=0;g<d.length;g++){var h=d[g];var k=undefined;var j=new Xmpp4Js.Muc.MucParticipant(b,h.jid,k);f.push(j)}a(b,f)})},join:function(a,d){if(this.isJoined()){this.part()}this._myNick=a;var e=this._createPresence("available");var c=e.getExtension(Xmpp4Js.Ext.Muc.XMLNS);if(d){c.setPassword(d)}var b=this._getMucManager()._getConnection();b.send(e,function(h){var f=this._getMucManager()._getExtManager();h.loadExtensions(f);var g="join";if(h.getExtension(Xmpp4Js.Ext.Error.XMLNS)!=undefined){g="error"}this.fireEvent(g,this,null,h)}.bind(this))},part:function(){var b=this._createPresence("unavailable");var a=this._getMucManager()._getConnection();a.send(b,function(c){this.fireEvent("part",this,null,c);this._myNick=undefined}.bind(this))},sendMessage:function(b){b.setType("groupchat");b.setTo(this.getRoomJid());var a=this._getMucManager()._getConnection();a.send(b)},sendText:function(b){var a=new Xmpp4Js.Packet.Message(this.getRoomJid(),"groupchat",b);this.sendMessage(a)},isJoined:function(){return this._myNick?true:false},createPrivateChat:function(a){},_createPresence:function(c){var d=this.getRoomJid()+"/"+this._myNick;var e=new Xmpp4Js.Packet.Presence(c,d);var b=this._getMucManager()._getExtManager();var a=b.create(Xmpp4Js.Ext.Muc.XMLNS,e);return e}};Ext.extend(Xmpp4Js.Muc.StatefulMucRoom,Xmpp4Js.Muc.MucRoom,Xmpp4Js.Muc.StatefulMucRoom.prototype);Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.MucPresenceFilter=function(a){this.fromJid=a;this.presenceFilter=new Xmpp4Js.PacketFilter.PacketTypeFilter(Xmpp4Js.Packet.Presence);if(a!=undefined){this.fromFilter=new Xmpp4Js.PacketFilter.FromContainsFilter(a)}};Xmpp4Js.Muc.MucPresenceFilter.prototype={accept:function(d){if(!this.presenceFilter.accept(d)){return false}if(this.fromJid!=undefined&&d.getFrom().indexOf(this.fromJid)==-1){return false}var c=d.getNode().childNodes;for(var a=0;a<c.getLength();a++){var b=c.item(a);if(b.namespaceURI=="http://jabber.org/protocol/muc#user"){return true}}return false}};Ext.extend(Xmpp4Js.Muc.MucPresenceFilter,Xmpp4Js.PacketFilter.PacketFilter,Xmpp4Js.Muc.MucPresenceFilter.prototype);Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.MucError=function(a){this.code=a};Xmpp4Js.Muc.JoinError=function(a){Xmpp4Js.Muc.JoinError.superclass.constructor.call(this,a)};Xmpp4Js.Muc.JoinError.prototype={};Ext.extend(Xmpp4Js.Muc.JoinError,Xmpp4Js.Muc.MucError,Xmpp4Js.Muc.JoinError.prototype);Ext.namespace("Xmpp4Js.Muc");Xmpp4Js.Muc.MucManager=function(a,c,b){this.con=a;this.node=c;this.extProvider=b;this.con.addPacketListener();this.addEvents({participantupdated:true})};Xmpp4Js.Muc.MucManager.getInstanceFor=function(a,c,b){if(a._mucManager==undefined){a._mucManager={}}if(a._mucManager[c]==null){a._mucManager[c]=new Xmpp4Js.Muc.MucManager(a,c,b)}return a._mucManager[c]};Xmpp4Js.Muc.MucManager.getMucNodes=function(a,b){return["conference.soashable.com"]};Xmpp4Js.Muc.MucManager.prototype={getRoomList:function(a){var c=this._getConnection().getServiceDisco();var b=this;c.discoverItems(this.node,function(g,d){var j=[];for(var e=0;e<d.length;e++){var f=d[e];var h=new Xmpp4Js.Muc.MucRoom(b,f.jid,f.name);j.push(h)}a(b,j)})},getRoom:function(b){var a=b+"@"+this.node;return new Xmpp4Js.Muc.MucRoom(this,a,b)},_getConnection:function(){return this.con},_getExtManager:function(){return this.extProvider}};Ext.extend(Xmpp4Js.Muc.MucManager,Ext.util.Observable,Xmpp4Js.Muc.MucManager.prototype);Ext.namespace("Xmpp4Js.Ext");Xmpp4Js.Ext.Muc=function(a){Xmpp4Js.Ext.Muc.superclass.constructor.call(this,a)};Xmpp4Js.Ext.Muc.XMLNS="http://jabber.org/protocol/muc";Xmpp4Js.Ext.Muc.prototype={getElementNS:function(){return Xmpp4Js.Ext.Muc.XMLNS},setPassword:function(a){throw new Error("TODO implement")}};Ext.extend(Xmpp4Js.Ext.Muc,Xmpp4Js.Ext.PacketExtension,Xmpp4Js.Ext.Muc.prototype);Ext.namespace("Xmpp4Js.Ext");Xmpp4Js.Ext.MucUser=function(a){Xmpp4Js.Ext.MucUser.superclass.constructor.call(this,a)};Xmpp4Js.Ext.MucUser.XMLNS="http://jabber.org/protocol/muc#user";Xmpp4Js.Ext.MucUser.prototype={getElementNS:function(){return Xmpp4Js.Ext.MucUser.XMLNS}};Ext.extend(Xmpp4Js.Ext.MucUser,Xmpp4Js.Ext.PacketExtension,Xmpp4Js.Ext.MucUser.prototype);function DataForm(){this.node=null}DataForm.prototype.read=function(a){if(a.nodeName!="x"||a.namespaceURI!="jabber:x:data"){alert("nothin");return}else{if(a.getAttribute("type")=="result"&&a.getElementsByTagName("reported").length>0){alert("does not support 'result' forms with 'reported' elements.");return}}this.node=a.cloneNode(true);return this.node};DataForm.prototype.write=function(c){var b=this.node.cloneNode(true);b=importNode(c.ownerDocument,b,true);if(c.nodeName=="x"&&c.namespanamespaceURI=="jabber:x:data"){var a=c.parentNode;b=a.replaceChild(b,c)}else{b=c.appendChild(b)}return b};DataForm.prototype.getFieldNames=function(){var a=[];var c=this.node.getElementsByTagName("field");for(var b=0;b<c.length;b++){var d=c[b];a.push(d.getAttribute("var"))}return a};DataForm.prototype.getFieldElem=function(b){var a=$A(this.node.getElementsByTagName("field")).findAll(function(c){return c.getAttribute("var")==b});return a.length>0?a[0]:null};DataForm.prototype.setFieldValues=function(g,e,d){var f=this.getFieldElem(g);if(f==null){return}if(e==null){e=[]}if(!(e instanceof Array)){e=[e]}if(!d){var b=f.getElementsByTagName("value");for(var c=0;c<b.length;c++){var a=b[c];a.parentNode.removeChild(a)}}for(var c=0;c<e.length;c++){var a=f.ownerDocument.createElement("value");a=f.appendChild(a);a.textContent=e[c]}};DataForm.prototype.getFieldValues=function(f){var e=this.getFieldElem(f);if(e==null){return}var c=[];var b=e.getElementsByTagName("value");for(var d=0;d<b.length;d++){var a=b[d];c.push(a.textContent)}return c};DataForm.prototype.getFieldType=function(b){var a=this.getFieldElem(b);if(a==null){return}return a.getAttribute("type")};DataForm.prototype.getFieldLabel=function(b){var a=this.getFieldElem(b);if(a==null){return}return a.getAttribute("label")};DataForm.prototype.getFieldDescription=function(c){var b=this.getFieldElem(c);if(b==null){return}var a=b.getElementsByTagName("desc");return a.length>0?a[0].textContent:null};DataForm.prototype.isFieldRequired=function(c){var b=this.getFieldElem(c);if(b==null){return}var a=b.getElementsByTagName("required");return a.length>0};DataForm.prototype.getFieldOptions=function(f){var e=this.getFieldElem(f);if(e==null){return}var b=[];var a=e.getElementsByTagName("option");for(var c=0;c<a.length;c++){var d=a[c];b.push({label:d.getAttribute("label"),value:d.getElementsByTagName("value")[0]})}};DataForm.prototype.getInstructions=function(){var a=this.node.getElementsByTagName("instructions");return a.length>0?a[0].textContent:null};DataForm.prototype.getTitle=function(){var a=this.node.getElementsByTagName("title");return a.length>0?a[0].textContent:null};DataForm.prototype.getType=function(){var a=this.node.getAttribute("type")};function DataFormEmulator(a){this.mapping=a}DataFormEmulator.prototype={read:function(e){var l=e.ownerDocument;var f=l.createElementNS("jabber:x:data","x");f.setAttribute("type","form");for(var d in this.mapping){var c=e.getElementsByTagName(d)[0];var b=this.mapping[d];var n=b.name;var j=b.label;var i=b.type;var k=b.value;var g=b.desc;var h=b.required;var o=b.options;var a=f.appendChild(l.createElement("field"));var m=a.appendChild(l.createElement("value"));a.setAttribute("var",n);if(j){a.setAttribute("label",j)}if(g){a.setAttribute("desc",g)}if(h){a.setAttribute("required",h)}if(o){}if(b.value){m.textContent=b.value}}return DataFormEmulator.superclass.read.call(this,f)},write:function(c){var e=c.ownerDocument;for(var d in this.mapping){var a=c.appendChild(e.createElement(d));var b=this.mapping[d];a.textContent=this.getFieldValues(b.name)[0]}return c}};Ext.extend(DataFormEmulator,DataForm,DataFormEmulator.prototype);function DataFormView(a){if(arguments.length>1){console.warn("Using deprecated ctor for DataFormView");a={dataForm:arguments[0],formId:arguments[1],template:arguments[2]}}if(!a.template){a.template=DataFormView.DEFAULT_TEMPLATE}this.dataForm=a.dataForm;this.formId=a.formId;this.template=a.template;this.addEvents({submit:true,reset:true,cancel:true});this.dfvContainerId=Ext.id();var b=Ext.apply(a,{layout:"fit",deferredRender:false,items:{id:this.dfvContainerId},buttons:[{text:"Cancel",scope:this,handler:this.cancelClicked},{text:"Reset",scope:this,handler:this.resetClicked},{text:"Save",scope:this,handler:this.saveClicked}]});DataFormView.superclass.constructor.call(this,b)}DataFormView.DEFAULT_TEMPLATE="resources/xmpp4js/DataForm-to-HTML.xsl";DataFormView.prototype={getRenderedNode:function(){console.warn("renderAndReturn is deprecated.");return this.renderAndReturn()},renderAndReturn:function(){var a=null;if(this.template.endsWith(".xsl")){var e=document.implementation.createDocument("","",null);var c=importNode(e,this.dataForm.node.cloneNode(true),true);e.appendChild(c);var d=new XMLHttpRequest();d.open("GET",this.template,false);d.send(null);var f=d.responseXML;var b=new XSLTProcessor();b.setParameter(null,"formId",this.formId);b.importStylesheet(f);a=b.transformToDocument(e)}else{var d=new XMLHttpRequest();d.open("GET",this.template,false);d.send(null);if(d.responseXML!=null){a=d.responseXML}else{throw new Error("non-XML response. cannot parse fragments at this time")}}return a},onRender:function(c,a){var b=Ext.ComponentMgr.get(this.dfvContainerId);var e=this.renderAndReturn();if(e==null){throw new Error("Error rendering DataForm with template: "+this.template)}var d=document.importNode(e.documentElement,true);c.body.dom.appendChild(d);this.bindToForm()},bindToForm:function(){var b=document.getElementById("form-"+this.formId);if(b==null){return}var a=document.getElementById(this.formId+"-submit");var c=document.getElementById(this.formId+"-cancel");if(c!=null){Ext.EventManager.on(c,"click",this.cancelClicked,this)}if(a!=null){Ext.EventManager.on(a,"click",this.submitClicked,this)}},getDataForm:function(){return this.dataForm},submitClicked:function(){var f=this.dataForm.getFieldNames();for(var d=0;d<f.length;d++){var k=f[d];var e=this.dataForm.getFieldType(k);switch(e){case"boolean":var g=null;var b=document.getElementById(this.formId+"-"+k+"-0");if(b.checked){g="0"}b=document.getElementById(this.formId+"-"+k+"-1");if(b.checked){g="1"}this.dataForm.setFieldValues(k,g);break;case"list-multi":case"list-single":var b=document.getElementById(this.formId+"-"+k);var h=[];for(var c=0;c<b.options.length;c++){var a=b.options[c];if(a.selected){h.push(a.value)}}this.dataForm.setFieldValues(k,h);break;default:var b=document.getElementById(this.formId+"-"+k);if(b==null){continue}this.dataForm.setFieldValues(k,b.value)}}this.fireEvent("submit",this)},cancelClicked:function(){this.fireEvent("cancel",this)},resetClicked:function(){this.fireEvent("reset",this)}};Ext.extend(DataFormView,Ext.Panel,DataFormView.prototype);function DataStorage(a){this.con=a}DataStorage.prototype.set=function(e,c,b){if(!b){b="element"}var d=this.con.getPacketHelper().createIQ(null,"set","jabber:iq:private");var a=d.getQuery().appendChild(d.getDoc().createElement(b));a.setAttribute("xmlns",e);if(typeof(c)=="string"){a.setTextContent(c)}else{a.appendChild(c)}this.con.send(d,function(f){if(f.getType()=="error"){alert("Error storing IQ: "+e+", "+b);return}})};DataStorage.prototype.get=function(e,c,b){if(!b){b="element"}var d=this.con.getPacketHelper().createIQ(null,"get","jabber:iq:private");var a=d.getQuery().appendChild(d.getDoc().createElement(b));a.setAttribute("xmlns",e);this.con.send(d,function(g){if(g.getType()=="error"){alert("Error retreiving IQ: "+e+", "+b);return}var f=g.getQuery().getElementsByTagNameNS(e,b);c(f)})};DataStorage.prototype.setString=function setData(c,b,a){this.set(c,b,a)};DataStorage.prototype.getString=function getData(c,b,a){this.get(c,function(d){var e="";$A(d[0].childNodes).each(function(f){e+=f.xml});b(e)},a)};function ServiceDiscoManager(a){this.addEvents({inforesponse:true,itemresponse:true});this.con=a}ServiceDiscoManager.prototype={registerPacketListeners:function(){this.con.addPacketListener(this.onDiscoItemsRequest.bind(this),new Xmpp4Js.PacketFilter.IQQueryNSFilter("http://jabber.org/protocol/disco#items"));this.con.addPacketListener(this.onDiscoIInfoRequest.bind(this),new Xmpp4Js.PacketFilter.IQQueryNSFilter("http://jabber.org/protocol/disco#info"))},discoverInfo:function(a,b){var d=this.con.getPacketHelper().createIQ(a,"get","http://jabber.org/protocol/disco#info");d.setId("disco_info_"+a);var c=d.getQuery();if(b){c.setAttribute("node",b)}this.con.send(d,this.onDiscoInfoResponse.bind(this))},discoverItems:function(a,b){var d=this.con.getPacketHelper().createIQ(a,"get","http://jabber.org/protocol/disco#items");var c=d.getQuery();if(b){c.setAttribute("node",b)}this.con.send(d,this.onDiscoItemsResponse.bind(this))},features:[],addFeature:function(a){this.features[a]=true},includesFeature:function(a){return this.features[a]!=undefined},removeFeature:function(a){delete this.features[a]},getFeatures:function(){var b=[];for(var a in this.features){b.push(a)}return b},onDiscoItemsRequest:function(b){var a=this.con.getPacketHelper().createIQ(b.getFrom(),"result","http://jabber.org/protocol/disco#items");a.setId(b.getId());this.con.send(a)},onDiscoIInfoRequest:function(f){var b=this.con.getPacketHelper().createIQ(f.getFrom(),"result","http://jabber.org/protocol/disco#info");b.setId(f.getId());var a=b.getQuery();var g=a.ownerDocument;for(var d=0;d<this.features.length;d++){var c=this.features[d];var e=g.createElement("feature");e.setAttribute("var",c);a.appendChild(e)}this.con.send(b)},onDiscoItemsResponse:function(f){if(f.getType()=="error"){return}var a=[];var e=f.getQuery();if(e==null){return}var c=e.childNodes;for(var b=0;b<c.getLength();b++){var d=c.item(b);if(d.nodeName=="item"){a.push({jid:d.getAttribute("jid"),name:d.getAttribute("name"),action:d.getAttribute("action"),node:d.getAttribute("node")})}}this.fireEvent("itemresponse",new Jid(jid),node,a)},onDiscoInfoResponse:function(g){if(g.getType()=="error"){return}var c=[];var d=[];var f=g.getQuery();if(f==null){return}var b=f.childNodes;for(var a=0;a<b.getLength();a++){var e=b.item(a);if(e.nodeName=="identity"){c.push({category:e.getAttribute("category"),name:e.getAttribute("name"),type:e.getAttribute("type")})}else{if(e.nodeName=="feature"){d.push(e.getAttribute("var"))}}}this.fireEvent("inforesponse",new Jid(jid),node,c,d)}};ServiceDiscoManager.instances={};ServiceDiscoManager.getInstanceFor=function(a){var b=ServiceDiscoManager.instances;if(b[a.id]===undefined){b[a.id]=new ServiceDiscoManager(a)}return b[a.id]};Ext.extend(ServiceDiscoManager,Ext.util.Observable,ServiceDiscoManager.prototype);function TransportHelper(){}TransportHelper.discoverGateways=function(c,a){var b={};var d=function(e){if(b[e]){return}b[e]=true;c.discoverInfo(e,function(j,g,h){for(var f=0;f<g.length;f++){var k=g[f];if(k.category=="gateway"){a(j,k)}}c.discoverItems(j,function(m,l){for(var n=0;n<l.length;n++){var o=l[n];d(o.jid)}})})};d(c.con.domain)};TransportHelper.registerForAim=function(a,e,c,b){var d=a.getPacketHelper().createIQ(e,"get","jabber:iq:register");d.setId("get_aim_"+c);a.send(d,function(h){var g=a.getPacketHelper().createIQ(e,"set","jabber:iq:register");g.setId("set_aim_"+c);var f=g.getQuery();f.appendChild(g.getDoc().createElement("username")).setTextContent(c);f.appendChild(g.getDoc().createElement("password")).setTextContent(b);a.send(g,function(i){if(i.getType()=="error"){alert("There was a problem trying to register the screen name "+c);return}a.getRoster().createEntry(e);var j=a.getPacketHelper().createPresence();j.setTo(e);a.send(j)})})};Ext.namespace("Xmpp4Js.Workflow");Xmpp4Js.Workflow.Login=function(a){this.con=a.con;this.listeners=a.listeners;this.addEvents({success:true,failure:true});Xmpp4Js.Workflow.Login.superclass.constructor.call(this,a)};Xmpp4Js.Workflow.Login.prototype={start:function(b,d,a,c){if(!c){c="xmpp4js"}if(b=="plaintext"){this.authPlaintext(d,a,c)}else{if(b=="anon"){this.authAnon()}}},authPlaintext:function(d,a,b){var c=new Xmpp4Js.Packet.AuthPlainText(d,a,b);c.setTo(this.con.domain);this.con.send(c,function(e){if(e.getType()=="error"){this.fireEvent("failure",e)}else{this.con.jid=e.getTo();this.fireEvent("success",e)}}.bind(this))},authAnon:function(){var a=new Xmpp4Js.Packet.IQ(this.domain,"set","jabber:iq:auth");this.con.send(a,function(b){if(b.getType()=="error"){this.fireEvent("failure",b)}else{this.con.jid=b.getTo();this.fireEvent("success",b)}}.bind(this))}};Ext.extend(Xmpp4Js.Workflow.Login,Ext.util.Observable,Xmpp4Js.Workflow.Login.prototype);Ext.namespace("Xmpp4Js.Workflow");Xmpp4Js.Workflow.Registration=function(a){this.con=a.con;this.listeners=a.listeners;this.toJid=a.toJid||this.con.jid;this.addEvents({success:true,failure:true});Xmpp4Js.Workflow.Registration.superclass.constructor.call(this,a)};Xmpp4Js.Workflow.Registration.prototype={start:function(a){var b=new Xmpp4Js.Packet.Registration(this.toJid,a);this.con.send(b,this.onRegResponse.bind(this))},onRegResponse:function(a){if(a.getType()=="error"){this.fireEvent("failure",a)}else{if(a.getType()=="result"){this.fireEvent("success",a)}}}};Ext.extend(Xmpp4Js.Workflow.Registration,Ext.util.Observable,Xmpp4Js.Workflow.Registration.prototype);